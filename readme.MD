# INSTALACION

## CloudFrontService

Perfecto Ra√∫l. A continuaci√≥n te detallo exactamente **qu√© opciones debes seleccionar al crear una nueva distribuci√≥n de CloudFront** para entregar **contenido HLS (.m3u8/.ts) con URLs firmadas usando el sistema moderno** (Public Keys y Key Groups).

---

## üß≠ PASO A PASO PARA CREAR TU DISTRIBUCI√ìN CLOUDFRONT SEGURA

---

### üîπ 1. **Distribution options**

* ‚úÖ **Selecciona:** `Single website or app`

---

### üîπ 2. **Origin**

* **Origin domain**: Si tu video est√° en un bucket S3 privado:

  ```
  nombre-del-bucket.s3.amazonaws.com
  ```

  > ‚ö†Ô∏è Aseg√∫rate de que el bucket est√© **privado** y tengas habilitado CloudFront como m√©todo de acceso.

* **Origin path (opcional)**: Deja vac√≠o, a menos que todos tus videos est√©n en un subdirectorio como `/videos`.

* **Name**: Ponle un nombre descriptivo, como `s3-origin-videos`.

* **Add custom header**: No es necesario.

* **Enable Origin Shield**:
  ‚ùå No

---

### üîπ 3. **Default cache behavior**

* **Path pattern**: Default `(*)`

* **Compress objects automatically**:
  ‚úÖ `Yes`

#### **Viewer**

* **Viewer protocol policy**:
  ‚úÖ `Redirect HTTP to HTTPS`

* **Allowed HTTP methods**:
  ‚úÖ `GET, HEAD` (solo necesitas servir archivos)

* **Restrict viewer access**:
  ‚úÖ `Yes` ‚Üí Esto es **esencial** para usar URLs firmadas.

#### **Cache key and origin requests**

* ‚úÖ `Cache policy and origin request policy (recommended)`

  * **Cache policy**:
    Selecciona: `CachingOptimized`

  * **Origin request policy**:
    Selecciona: `AllViewerExceptHostHeader` o crea uno nuevo si necesitas headers especiales.

  * **Response headers policy**:
    Opcional. Puedes dejarlo vac√≠o.

---

### üîπ 4. **Function associations**

* ‚ùå No necesitas configurar funciones en este momento.

---

### üîπ 5. **Web Application Firewall (WAF)**

* ‚úÖ Puedes seleccionar `Do not enable` (puedes agregarlo luego si necesitas protecci√≥n).

---

### üîπ 6. **Price class**

* ‚úÖ Puedes seleccionar seg√∫n tu p√∫blico:

  * `Use only North America and Europe` si solo tienes usuarios en esas regiones
  * `Use all edge locations` para mejor rendimiento global

---

### üîπ 7. **Alternate domain name (CNAME)** (opcional)

* Si vas a usar un dominio propio, agr√©galo aqu√≠ (ej. `videos.tudominio.com`)
* Si no, deja vac√≠o

---

### üîπ 8. **Custom SSL certificate**

* Si usaste un CNAME, aqu√≠ debes **seleccionar el certificado SSL** desde AWS Certificate Manager.
* Si no tienes uno a√∫n, haz clic en **"Request certificate"**

> El certificado debe estar en la regi√≥n `us-east-1` (Virginia del Norte).

---

### üîπ 9. **Supported HTTP versions**

* ‚úÖ Marca `HTTP/2` y `HTTP/3` (mejora de rendimiento)

---

### üîπ 10. **Default root object**

* ‚ùå D√©jalo vac√≠o (no aplica para contenido HLS)

---

### üîπ 11. **IPv6**

* ‚úÖ `On`

---

### üîπ 12. **Standard logging**

* ‚ùå `Off` (puedes activarlo despu√©s si deseas auditar tr√°fico)

---

## ‚úÖ FINALIZA

Haz clic en **Create distribution**.

Una vez creada:

* Ve a **Behaviors > Edit**
* En la secci√≥n de seguridad, asocia el **Key Group** que creaste anteriormente.

### kEY MANAGEMENT

#### 1. Genera tu par de claves (privada y p√∫blica RSA)

En tu m√°quina local, corre:

```bash
openssl genrsa -out private_key.pem 2048
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

Esto te dar√°:
* `private_key.pem`: la usar√°s para firmar las URLs.
* `public_key.pem`: la subir√°s a AWS.

#### 2. Crea la clave p√∫blica en AWS

1. Ve a [CloudFront > Key Management > Public Keys](https://console.aws.amazon.com/cloudfront/v3/home#/public-keys)
2. Haz clic en **"Create public key"**
3. Ponle un nombre y pega el contenido de `public_key.pem`
4. Guarda el `ID` de la clave p√∫blica (ejemplo: `K123ABC456XYZ`)

#### 3. Crea un **Key Group**

1. Ve a **CloudFront > Key Groups**
2. Haz clic en **"Create key group"**
3. Ponle nombre
4. Selecciona la clave p√∫blica que creaste antes
5. Guarda el **ID del Key Group** (ejemplo: `abcd1234-keygroup`)

#### 4. Asocia el Key Group a tu distribuci√≥n de CloudFront

1. Ve a tu distribuci√≥n de CloudFront
2. En **Behaviors > Edit**, busca la secci√≥n **Restrict viewer access (signed URLs or signed cookies)**
3. Selecciona **Yes**
4. En "Trusted key groups", agrega el Key Group creado

Guarda los cambios.

---

#### 5. Guarda tu clave privada en Laravel

Guarda `private_key.pem` en tu proyecto, por ejemplo en:

```
storage/cloudfront/private_key.pem
```

---

#### 6. Agrega configuraci√≥n en `.env`

```
CLOUDFRONT_DOMAIN=https://tudistribucion.cloudfront.net
CLOUDFRONT_PUBLIC_KEY_ID=K123ABC456XYZ
CLOUDFRONT_PRIVATE_KEY_PATH=storage/cloudfront/private_key.pem
CLOUDFRONT_URL_EXPIRATION=240
```

---

#### 7. Agrega la configuraci√≥n a `config/videoprocessor.php`

```php
'cloudfront' => [
    'domain' => env('CLOUDFRONT_DOMAIN'),
    'public_key_id' => env('CLOUDFRONT_PUBLIC_KEY_ID'),
    'private_key_path' => base_path(env('CLOUDFRONT_PRIVATE_KEY_PATH')),
    'url_expiration' => env('CLOUDFRONT_URL_EXPIRATION', 240),
],
```

---

#### 8. L√≥gica para generar una URL firmada

Aqu√≠ tienes una clase de servicio compatible con el sistema moderno:

```php
use Carbon\Carbon;

class ModernCloudFrontService
{
    public function generateSignedUrl(string $resourceUrl): string
    {
        $expires = Carbon::now()->addMinutes(config('videoprocessor.cloudfront.url_expiration'))->timestamp;

        $policy = json_encode([
            'Statement' => [[
                'Resource' => $resourceUrl,
                'Condition' => [
                    'DateLessThan' => ['AWS:EpochTime' => $expires],
                ],
            ]],
        ]);

        $privateKey = file_get_contents(config('videoprocessor.cloudfront.private_key_path'));

        openssl_sign($policy, $signature, $privateKey, OPENSSL_ALGO_SHA1);
        $encodedPolicy = strtr(base64_encode($policy), ['+' => '-', '=' => '_', '/' => '~']);
        $encodedSignature = strtr(base64_encode($signature), ['+' => '-', '=' => '_', '/' => '~']);

        return $resourceUrl
            . '?Policy=' . $encodedPolicy
            . '&Signature=' . $encodedSignature
            . '&Key-Pair-Id=' . config('videoprocessor.cloudfront.public_key_id');
    }
}
```

---

#### 9. C√≥mo usarla

```php
$service = new ModernCloudFrontService();
$url = $service->generateSignedUrl('https://tudistribucion.cloudfront.net/path/to/video/index.m3u8');
return redirect()->away($url);
```

---

#### ‚úÖ Resultado

El sistema generar√° URLs como:

```
https://yourcdn.cloudfront.net/video/abc/index.m3u8?Policy=...&Signature=...&Key-Pair-Id=K123ABC456XYZ
```

Y solo podr√°n reproducirse si son v√°lidas y no han expirado.

---

## Notificaciones de SNS para el procesamiento de MediaConverter 

‚úÖ 1. Crea un SNS Topic en AWS
Ve a AWS SNS.

Crea un Topic de tipo Standard.

Dale un nombre (ej. MediaConvertJobNotifications).

Guarda el ARN del topic (lo usar√°s en MediaConvert).

# TODO

1. AutoGenerateTranslatedVttRequest & UploadTranslatedVttRequest usan el modelo Language
    - No deber√≠a ser as√≠, ya que es una acoplamiento con la app principal
2. Hacer que el paquete use su propio modelo Video yque tenga un trait para todos los mutators y relaciones
3. Ver si este paquete asume el modelo Languaje & Subtitles dentro de su misma estructura.