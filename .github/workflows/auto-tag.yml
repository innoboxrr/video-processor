name: Increment Version and Create Tag

on:
    push:
        branches:
            - master

jobs:
    increment-version:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Get latest tag
          id: get_tag
          run: |
              latest_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
              if [ -z "$latest_tag" ]; then
                echo "::set-output name=tag::0.0.0"
              else
                echo "::set-output name=tag::$latest_tag"
              fi

        - name: Bump version
          id: bump_version
          run: |
              IFS='.' read -r -a version_parts <<< "${{ steps.get_tag.outputs.tag }}"
              major=${version_parts[0]}
              minor=${version_parts[1]}
              patch=${version_parts[2]}
              new_patch=$((patch + 1))
              new_tag="$major.$minor.$new_patch"
              echo "::set-output name=new_tag::$new_tag"

        - name: Create new tag
          env:
            # GITHUB_TOKEN is automatically provided by GitHub Actions and doesn't need to be created manually
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
              git config --global user.name "github-actions"
              git config --global user.email "github-actions@github.com"
              git tag ${{ steps.bump_version.outputs.new_tag }}
              git push origin ${{ steps.bump_version.outputs.new_tag }}
